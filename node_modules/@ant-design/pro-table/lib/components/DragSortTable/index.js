"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _objectSpread2 = _interopRequireDefault(require("@babel/runtime/helpers/objectSpread2"));

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

require("antd/es/config-provider/style");

var _configProvider = _interopRequireDefault(require("antd/es/config-provider"));

var _objectWithoutProperties2 = _interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));

var _react = _interopRequireWildcard(require("react"));

var _useDragSort2 = require("../../utils/useDragSort");

var _Table = _interopRequireDefault(require("../../Table"));

var _reactSortableHoc = require("react-sortable-hoc");

var _icons = require("@ant-design/icons");

var _proUtils = require("@ant-design/pro-utils");

require("./index.less");

var _excluded = ["rowKey", "dragSortKey", "dragSortHandlerRender", "onDragSortEnd", "onDataSourceChange", "columns", "dataSource"];

// 用于创建可拖拽把手组件的工厂
var handleCreator = function handleCreator(handle) {
  return (0, _reactSortableHoc.SortableHandle)(function () {
    return /*#__PURE__*/_react.default.createElement(_react.default.Fragment, null, handle);
  });
};

function DragSortTable(props) {
  var rowKey = props.rowKey,
      dragSortKey = props.dragSortKey,
      dragSortHandlerRender = props.dragSortHandlerRender,
      onDragSortEnd = props.onDragSortEnd,
      onDataSourceChange = props.onDataSourceChange,
      propsColumns = props.columns,
      oriDs = props.dataSource,
      otherProps = (0, _objectWithoutProperties2.default)(props, _excluded);

  var _useContext = (0, _react.useContext)(_configProvider.default.ConfigContext),
      getPrefixCls = _useContext.getPrefixCls; // 默认拖拽把手


  var DragHandle = (0, _react.useMemo)(function () {
    return handleCreator( /*#__PURE__*/_react.default.createElement(_icons.MenuOutlined, {
      className: getPrefixCls('pro-table-drag-icon')
    }));
  }, [getPrefixCls]);

  var _useState = (0, _react.useState)(propsColumns),
      _useState2 = (0, _slicedToArray2.default)(_useState, 2),
      columns = _useState2[0],
      setRefColumns = _useState2[1];

  var isDragSortColumn = (0, _react.useCallback)(function (item) {
    return item.key === dragSortKey || item.dataIndex === dragSortKey;
  }, [dragSortKey]); // 根据 dragSortKey 查找目标列配置

  var handleColumn = (0, _react.useMemo)(function () {
    return propsColumns === null || propsColumns === void 0 ? void 0 : propsColumns.find(function (item) {
      return isDragSortColumn(item);
    });
  }, [propsColumns, isDragSortColumn]); // 记录原始列配置

  var originColumnRef = (0, _react.useRef)((0, _objectSpread2.default)({}, handleColumn)); // 使用自定义hooks获取拖拽相关组件的components集合

  var _useDragSort = (0, _useDragSort2.useDragSort)({
    data: oriDs === null || oriDs === void 0 ? void 0 : oriDs.slice(),
    dragSortKey: dragSortKey,
    onDragSortEnd: onDragSortEnd,
    components: props.components,
    rowKey: rowKey
  }),
      components = _useDragSort.components; // 重写列配置的render,并在卸载时恢复原始render


  (0, _proUtils.useDeepCompareEffectDebounce)(function () {
    var originColumn = originColumnRef.current;
    if (!handleColumn) return function () {};

    var dargRender = function dargRender() {
      var _originColumn$render;

      for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {
        args[_key] = arguments[_key];
      }

      var dom = args[0],
          rowData = args[1],
          index = args[2],
          action = args[3],
          schema = args[4];
      var RealHandle = dragSortHandlerRender ? handleCreator(dragSortHandlerRender(rowData, index)) : DragHandle;
      return /*#__PURE__*/_react.default.createElement("div", {
        className: getPrefixCls('pro-table-drag-visible-cell')
      }, /*#__PURE__*/_react.default.createElement(RealHandle, null), (_originColumn$render = originColumn.render) === null || _originColumn$render === void 0 ? void 0 : _originColumn$render.call(originColumn, dom, rowData, index, action, schema));
    }; // 重新生成数据


    setRefColumns(columns === null || columns === void 0 ? void 0 : columns.map(function (item) {
      if (!isDragSortColumn(item)) {
        return item;
      }

      return (0, _objectSpread2.default)((0, _objectSpread2.default)({}, item), {}, {
        render: dargRender
      });
    }));
    /* istanbul ignore next */

    return function () {
      setRefColumns(props.columns);
    };
  }, [dragSortHandlerRender, handleColumn], ['render', 'renderFormItem']);
  return handleColumn ? /*#__PURE__*/_react.default.createElement(_Table.default, (0, _extends2.default)({}, otherProps, {
    rowKey: rowKey,
    dataSource: oriDs,
    components: components,
    columns: columns,
    onDataSourceChange: onDataSourceChange
  })) :
  /*#__PURE__*/

  /* istanbul ignore next */
  _react.default.createElement(_Table.default, (0, _extends2.default)({}, otherProps, {
    rowKey: rowKey,
    dataSource: oriDs,
    columns: columns,
    onDataSourceChange: onDataSourceChange
  }));
}

var _default = DragSortTable;
exports.default = _default;