"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.useDragSort = useDragSort;

var _objectSpread2 = _interopRequireDefault(require("@babel/runtime/helpers/objectSpread2"));

var _objectWithoutProperties2 = _interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _reactSortableHoc = require("react-sortable-hoc");

var _react = _interopRequireWildcard(require("react"));

var _index = require("./index");

var _excluded = ["className", "style"];

function useDragSort(props) {
  var _props$data = props.data,
      data = _props$data === void 0 ? [] : _props$data,
      onDragSortEnd = props.onDragSortEnd,
      dragSortKey = props.dragSortKey; // 拖拽排序相关逻辑

  var SortableItem = (0, _reactSortableHoc.SortableElement)(function (p) {
    return /*#__PURE__*/_react.default.createElement("tr", p);
  });
  var SortContainer = (0, _reactSortableHoc.SortableContainer)(function (p) {
    return /*#__PURE__*/_react.default.createElement("tbody", p);
  });
  /* istanbul ignore next */

  var handleSortEnd = (0, _react.useCallback)(function (params) {
    /* istanbul ignore next */
    var newDs = (0, _index.sortData)(params, data);
    /* istanbul ignore next */

    if (newDs && onDragSortEnd) {
      /* istanbul ignore next */
      onDragSortEnd(newDs);
    }
  }, [data, onDragSortEnd]);

  var DraggableContainer = function DraggableContainer(p) {
    return /*#__PURE__*/_react.default.createElement(SortContainer, (0, _extends2.default)({
      useDragHandle: true,
      disableAutoscroll: true,
      helperClass: "row-dragging",
      onSortEnd: handleSortEnd
    }, p));
  };

  var DraggableBodyRow = function DraggableBodyRow(p) {
    var DraggableBodyRowClassName = p.className,
        DraggableBodyRowStyle = p.style,
        restProps = (0, _objectWithoutProperties2.default)(p, _excluded); // function findIndex base on Table rowKey props and should always be a right array index

    var index = data.findIndex(function (x) {
      var _props$rowKey;

      return x[(_props$rowKey = props.rowKey) !== null && _props$rowKey !== void 0 ? _props$rowKey : 'index'] === restProps['data-row-key'];
    });
    return /*#__PURE__*/_react.default.createElement(SortableItem, (0, _extends2.default)({
      index: index
    }, restProps));
  };

  var components = props.components || {};

  if (dragSortKey) {
    var _props$components;

    components.body = (0, _objectSpread2.default)((0, _objectSpread2.default)({}, ((_props$components = props.components) === null || _props$components === void 0 ? void 0 : _props$components.body) || {}), {}, {
      wrapper: DraggableContainer,
      row: DraggableBodyRow
    });
  }

  return {
    components: components
  };
}