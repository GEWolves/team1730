"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.TYPE = void 0;

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _objectSpread2 = _interopRequireDefault(require("@babel/runtime/helpers/objectSpread2"));

var _objectWithoutProperties2 = _interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));

var _react = _interopRequireWildcard(require("react"));

var _proUtils = require("@ant-design/pro-utils");

var _classnames2 = _interopRequireDefault(require("classnames"));

var _warning = require("rc-util/lib/warning");

var _useJsonComparison = require("use-json-comparison");

var _FieldContext = _interopRequireDefault(require("../FieldContext"));

var _FormItem = _interopRequireDefault(require("../components/FormItem"));

var _rcFieldForm = require("rc-field-form");

var _excluded = ["valueType", "customLightMode", "lightFilterLabelFormatter", "valuePropName", "ignoreWidth", "defaultProps"],
    _excluded2 = ["label", "tooltip", "placeholder", "width", "proFieldProps", "bordered", "messageVariables", "ignoreFormItem", "transform", "readonly", "allowClear", "colSize", "formItemProps", "filedConfig", "cacheForSwr"];
var TYPE = Symbol('ProFormComponent');
exports.TYPE = TYPE;
var WIDTH_SIZE_ENUM = {
  // 适用于短数字，短文本或者选项
  xs: 104,
  s: 216,
  // 适用于较短字段录入、如姓名、电话、ID 等。
  sm: 216,
  m: 328,
  // 标准宽度，适用于大部分字段长度。
  md: 328,
  l: 440,
  // 适用于较长字段录入，如长网址、标签组、文件路径等。
  lg: 440,
  // 适用于长文本录入，如长链接、描述、备注等，通常搭配自适应多行输入框或定高文本域使用。
  xl: 552
};
/**
 * 这个方法的主要作用的帮助 Field 增加 FormItem 同时也会处理 lightFilter
 *
 * @param Field
 * @param config
 */

function createField(Field, config) {
  // 标记是否是 ProForm 的组件
  // @ts-ignore
  // eslint-disable-next-line no-param-reassign
  Field.displayName = 'ProFormComponent';

  var FieldWithContext = function FieldWithContext(props) {
    var _otherProps$name, _rest$fieldProps2, _field$props$allowCle, _field$props, _field$props2;

    var _ref = (0, _objectSpread2.default)((0, _objectSpread2.default)({}, props === null || props === void 0 ? void 0 : props.filedConfig), config) || {},
        valueType = _ref.valueType,
        customLightMode = _ref.customLightMode,
        lightFilterLabelFormatter = _ref.lightFilterLabelFormatter,
        _ref$valuePropName = _ref.valuePropName,
        valuePropName = _ref$valuePropName === void 0 ? 'value' : _ref$valuePropName,
        ignoreWidth = _ref.ignoreWidth,
        defaultProps = _ref.defaultProps,
        defaultFormItemProps = (0, _objectWithoutProperties2.default)(_ref, _excluded);

    var _defaultProps$props = (0, _objectSpread2.default)((0, _objectSpread2.default)({}, defaultProps), props),
        label = _defaultProps$props.label,
        tooltip = _defaultProps$props.tooltip,
        placeholder = _defaultProps$props.placeholder,
        width = _defaultProps$props.width,
        proFieldProps = _defaultProps$props.proFieldProps,
        bordered = _defaultProps$props.bordered,
        messageVariables = _defaultProps$props.messageVariables,
        ignoreFormItem = _defaultProps$props.ignoreFormItem,
        transform = _defaultProps$props.transform,
        readonly = _defaultProps$props.readonly,
        allowClear = _defaultProps$props.allowClear,
        colSize = _defaultProps$props.colSize,
        propsFormItemProps = _defaultProps$props.formItemProps,
        filedConfig = _defaultProps$props.filedConfig,
        cacheForSwr = _defaultProps$props.cacheForSwr,
        rest = (0, _objectWithoutProperties2.default)(_defaultProps$props, _excluded2);
    /** 从 context 中拿到的值 */


    var _React$useContext = _react.default.useContext(_FieldContext.default),
        fieldProps = _React$useContext.fieldProps,
        formItemProps = _React$useContext.formItemProps; // restFormItemProps is user props pass to Form.Item


    var restFormItemProps = (0, _proUtils.pickProFormItemProps)(rest);
    var formNeedProps = (0, _react.useMemo)(function () {
      return (0, _proUtils.omitUndefined)({
        value: rest.value
      }); // eslint-disable-next-line react-hooks/exhaustive-deps
    }, [rest.value]);
    var realFormItem = (0, _react.useMemo)(function () {
      if (!ignoreFormItem) {
        return {};
      }

      return (0, _proUtils.omitUndefined)(formNeedProps);
    }, [formNeedProps, ignoreFormItem]);
    var realFieldProps = (0, _react.useMemo)(function () {
      var _rest$fieldProps;

      return (0, _proUtils.omitUndefined)((0, _objectSpread2.default)((0, _objectSpread2.default)((0, _objectSpread2.default)((0, _objectSpread2.default)({}, realFormItem), {}, {
        disabled: props.disabled,
        placeholder: placeholder
      }, fieldProps || {}), rest.fieldProps || {}), {}, {
        style: (0, _proUtils.omitUndefined)((0, _objectSpread2.default)((0, _objectSpread2.default)({}, (_rest$fieldProps = rest.fieldProps) === null || _rest$fieldProps === void 0 ? void 0 : _rest$fieldProps.style), fieldProps === null || fieldProps === void 0 ? void 0 : fieldProps.style))
      }));
    }, [fieldProps, placeholder, props.disabled, realFormItem, rest.fieldProps]);
    var otherProps = (0, _objectSpread2.default)((0, _objectSpread2.default)((0, _objectSpread2.default)((0, _objectSpread2.default)({
      messageVariables: messageVariables
    }, defaultFormItemProps), formItemProps), restFormItemProps), propsFormItemProps);
    (0, _warning.noteOnce)( // eslint-disable-next-line @typescript-eslint/dot-notation
    !rest['defaultValue'], '请不要在 Form 中使用 defaultXXX。如果需要默认值请使用 initialValues 和 initialValue。');
    var ignoreWidthValueType = (0, _react.useMemo)(function () {
      return ['switch', 'radioButton', 'radio', 'rate'];
    }, []);

    var _useContext = (0, _react.useContext)(_rcFieldForm.FieldContext),
        prefixName = _useContext.prefixName;

    var proFieldKey = (0, _react.useMemo)(function () {
      /** 如果没有cacheForSwr，默认关掉缓存 只有table中默认打开，form中打开问题还挺多的，有些场景name 会相同 */
      if (!cacheForSwr) return undefined;
      var name = otherProps === null || otherProps === void 0 ? void 0 : otherProps.name;
      if (Array.isArray(name)) name = name.join('_');
      if (Array.isArray(prefixName) && name) name = "".concat(prefixName.join('.'), ".").concat(name);
      return name && "form-field-".concat(name); // eslint-disable-next-line react-hooks/exhaustive-deps
    }, [(0, _useJsonComparison.stringify)(otherProps === null || otherProps === void 0 ? void 0 : otherProps.name), prefixName]);
    var realFieldPropsStyle = (0, _react.useMemo)(function () {
      return (0, _objectSpread2.default)({}, realFieldProps === null || realFieldProps === void 0 ? void 0 : realFieldProps.style);
    }, // eslint-disable-next-line react-hooks/exhaustive-deps
    [(0, _useJsonComparison.stringify)(realFieldProps === null || realFieldProps === void 0 ? void 0 : realFieldProps.style)]);

    if (realFieldPropsStyle.width !== undefined && rest.valueType === 'switch') {
      delete realFieldPropsStyle.width;
    } // eslint-disable-next-line react-hooks/exhaustive-deps


    var propsValueType = (0, _react.useMemo)(function () {
      return rest.valueType;
    }, [rest.valueType]);
    var prefRest = (0, _proUtils.usePrevious)(rest);
    var field = (0, _react.useMemo)(function () {
      return /*#__PURE__*/_react.default.createElement(Field // ProXxx 上面的 props 透传给 FieldProps，可能包含 Field 自定义的 props，
      // 比如 ProFormSelect 的 request
      , (0, _extends2.default)({}, rest, {
        fieldProps: (0, _proUtils.omitUndefined)((0, _objectSpread2.default)((0, _objectSpread2.default)({
          allowClear: allowClear
        }, realFieldProps), {}, {
          style: (0, _proUtils.omitUndefined)((0, _objectSpread2.default)({
            width: width && !WIDTH_SIZE_ENUM[width] ? width : undefined
          }, realFieldPropsStyle)),
          className: (0, _classnames2.default)(realFieldProps === null || realFieldProps === void 0 ? void 0 : realFieldProps.className, (0, _defineProperty2.default)({
            'pro-field': width && WIDTH_SIZE_ENUM[width]
          }, "pro-field-".concat(width), width && // 有些 valueType 不需要宽度
          !ignoreWidthValueType.includes(propsValueType) && !ignoreWidth && WIDTH_SIZE_ENUM[width])) || undefined
        })),
        proFieldProps: (0, _proUtils.omitUndefined)((0, _objectSpread2.default)({
          // @ts-ignore
          mode: rest === null || rest === void 0 ? void 0 : rest.mode,
          readonly: readonly,
          params: rest.params,
          proFieldKey: proFieldKey
        }, proFieldProps))
      })); // eslint-disable-next-line react-hooks/exhaustive-deps
    }, [allowClear, ignoreWidth, ignoreWidthValueType, proFieldKey, // eslint-disable-next-line react-hooks/exhaustive-deps
    (0, _useJsonComparison.stringify)(proFieldProps), propsValueType, readonly, realFieldProps, realFieldPropsStyle, // eslint-disable-next-line react-hooks/exhaustive-deps
    (0, _proUtils.isDeepEqualReact)(prefRest, rest, ['onChange', 'onBlur', 'onFocus', 'record']) ? undefined : {}, width]);
    return /*#__PURE__*/_react.default.createElement(_FormItem.default // 全局的提供一个 tip 功能，可以减少代码量
    // 轻量模式下不通过 FormItem 显示 label
    , (0, _extends2.default)({
      label: label && (proFieldProps === null || proFieldProps === void 0 ? void 0 : proFieldProps.light) !== true ? label : undefined,
      tooltip: (proFieldProps === null || proFieldProps === void 0 ? void 0 : proFieldProps.light) !== true && tooltip,
      valuePropName: valuePropName,
      key: (_otherProps$name = otherProps.name) === null || _otherProps$name === void 0 ? void 0 : _otherProps$name.toString()
    }, otherProps, {
      ignoreFormItem: ignoreFormItem,
      transform: transform,
      dataFormat: (_rest$fieldProps2 = rest.fieldProps) === null || _rest$fieldProps2 === void 0 ? void 0 : _rest$fieldProps2.format,
      valueType: valueType || rest.valueType,
      messageVariables: (0, _objectSpread2.default)({
        label: label || ''
      }, otherProps === null || otherProps === void 0 ? void 0 : otherProps.messageVariables),
      lightProps: (0, _proUtils.omitUndefined)((0, _objectSpread2.default)((0, _objectSpread2.default)((0, _objectSpread2.default)({}, realFieldProps), {}, {
        valueType: valueType || rest.valueType,
        bordered: bordered,
        allowClear: (_field$props$allowCle = field === null || field === void 0 ? void 0 : (_field$props = field.props) === null || _field$props === void 0 ? void 0 : _field$props.allowClear) !== null && _field$props$allowCle !== void 0 ? _field$props$allowCle : allowClear,
        light: proFieldProps === null || proFieldProps === void 0 ? void 0 : proFieldProps.light,
        label: label,
        customLightMode: customLightMode,
        labelFormatter: lightFilterLabelFormatter,
        valuePropName: valuePropName,
        footerRender: field === null || field === void 0 ? void 0 : (_field$props2 = field.props) === null || _field$props2 === void 0 ? void 0 : _field$props2.footerRender
      }, rest.lightProps), otherProps.lightProps))
    }), field);
  }; // 标记是否是 proform 的组件
  // @ts-ignore
  // eslint-disable-next-line no-param-reassign


  FieldWithContext.displayName = 'ProFormComponent';
  return FieldWithContext;
}

var _default = createField;
exports.default = _default;