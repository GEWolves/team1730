import _extends from "@babel/runtime/helpers/esm/extends";
import _objectSpread from "@babel/runtime/helpers/esm/objectSpread2";
import _slicedToArray from "@babel/runtime/helpers/esm/slicedToArray";
import "antd/es/config-provider/style";
import _ConfigProvider from "antd/es/config-provider";
import _objectWithoutProperties from "@babel/runtime/helpers/esm/objectWithoutProperties";
var _excluded = ["rowKey", "dragSortKey", "dragSortHandlerRender", "onDragSortEnd", "onDataSourceChange", "columns", "dataSource"];
import React, { useMemo, useState, useCallback, useRef, useContext } from 'react';
import { useDragSort } from '../../utils/useDragSort';
import ProTable from '../../Table';
import { SortableHandle } from 'react-sortable-hoc';
import { MenuOutlined } from '@ant-design/icons';
import { useDeepCompareEffectDebounce } from '@ant-design/pro-utils';
import './index.less'; // 用于创建可拖拽把手组件的工厂

var handleCreator = function handleCreator(handle) {
  return SortableHandle(function () {
    return /*#__PURE__*/React.createElement(React.Fragment, null, handle);
  });
};

function DragSortTable(props) {
  var rowKey = props.rowKey,
      dragSortKey = props.dragSortKey,
      dragSortHandlerRender = props.dragSortHandlerRender,
      onDragSortEnd = props.onDragSortEnd,
      onDataSourceChange = props.onDataSourceChange,
      propsColumns = props.columns,
      oriDs = props.dataSource,
      otherProps = _objectWithoutProperties(props, _excluded);

  var _useContext = useContext(_ConfigProvider.ConfigContext),
      getPrefixCls = _useContext.getPrefixCls; // 默认拖拽把手


  var DragHandle = useMemo(function () {
    return handleCreator( /*#__PURE__*/React.createElement(MenuOutlined, {
      className: getPrefixCls('pro-table-drag-icon')
    }));
  }, [getPrefixCls]);

  var _useState = useState(propsColumns),
      _useState2 = _slicedToArray(_useState, 2),
      columns = _useState2[0],
      setRefColumns = _useState2[1];

  var isDragSortColumn = useCallback(function (item) {
    return item.key === dragSortKey || item.dataIndex === dragSortKey;
  }, [dragSortKey]); // 根据 dragSortKey 查找目标列配置

  var handleColumn = useMemo(function () {
    return propsColumns === null || propsColumns === void 0 ? void 0 : propsColumns.find(function (item) {
      return isDragSortColumn(item);
    });
  }, [propsColumns, isDragSortColumn]); // 记录原始列配置

  var originColumnRef = useRef(_objectSpread({}, handleColumn)); // 使用自定义hooks获取拖拽相关组件的components集合

  var _useDragSort = useDragSort({
    data: oriDs === null || oriDs === void 0 ? void 0 : oriDs.slice(),
    dragSortKey: dragSortKey,
    onDragSortEnd: onDragSortEnd,
    components: props.components,
    rowKey: rowKey
  }),
      components = _useDragSort.components; // 重写列配置的render,并在卸载时恢复原始render


  useDeepCompareEffectDebounce(function () {
    var originColumn = originColumnRef.current;
    if (!handleColumn) return function () {};

    var dargRender = function dargRender() {
      var _originColumn$render;

      for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {
        args[_key] = arguments[_key];
      }

      var dom = args[0],
          rowData = args[1],
          index = args[2],
          action = args[3],
          schema = args[4];
      var RealHandle = dragSortHandlerRender ? handleCreator(dragSortHandlerRender(rowData, index)) : DragHandle;
      return /*#__PURE__*/React.createElement("div", {
        className: getPrefixCls('pro-table-drag-visible-cell')
      }, /*#__PURE__*/React.createElement(RealHandle, null), (_originColumn$render = originColumn.render) === null || _originColumn$render === void 0 ? void 0 : _originColumn$render.call(originColumn, dom, rowData, index, action, schema));
    }; // 重新生成数据


    setRefColumns(columns === null || columns === void 0 ? void 0 : columns.map(function (item) {
      if (!isDragSortColumn(item)) {
        return item;
      }

      return _objectSpread(_objectSpread({}, item), {}, {
        render: dargRender
      });
    }));
    /* istanbul ignore next */

    return function () {
      setRefColumns(props.columns);
    };
  }, [dragSortHandlerRender, handleColumn], ['render', 'renderFormItem']);
  return handleColumn ? /*#__PURE__*/React.createElement(ProTable, _extends({}, otherProps, {
    rowKey: rowKey,
    dataSource: oriDs,
    components: components,
    columns: columns,
    onDataSourceChange: onDataSourceChange
  })) :
  /*#__PURE__*/

  /* istanbul ignore next */
  React.createElement(ProTable, _extends({}, otherProps, {
    rowKey: rowKey,
    dataSource: oriDs,
    columns: columns,
    onDataSourceChange: onDataSourceChange
  }));
}

export default DragSortTable;